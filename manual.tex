\documentclass[11pt,a4paper,titlepage]{article}
\usepackage[left=1.5cm,text={18cm, 25cm},top=2.5cm]{geometry}
\usepackage{setspace}
\usepackage{graphicx}
\usepackage[czech]{babel}
\usepackage[latin2]{inputenc}
\bibliographystyle{czplain}
\usepackage{etoolbox}
\apptocmd{\thebibliography}{\raggedright}{}{}
\setlength{\parindent}{0cm}
\setlength{\parskip}{1em}

% \title{Sí»ové aplikace a~správa sítí - POP3 server}
% \author{Jiøí Matìjka}
% \date{17. 11. 2017}
%
%
% \makeatletter
% \def\@maketitle{
% 	\begin{center}
% 		\includegraphics[width = 100mm]{logo.png}
% 		{\Huge \bfseries \sffamily \@title }\\[4ex]
% 		{\Large  \@author}\\[4ex]
% 		\@date\\[8ex]
% 	\end{center}}
% \makeatother

\begin{document}

		\setstretch{0.5}
		\begin{center}

			\includegraphics[width = 150mm]{logo.png}\\

			\vspace{\stretch{0.382}}

			\LARGE
			Sí»ové aplikace a~správa sítí\\
			Programování sí»ové slu¾by -- POP3 server\\
			\vspace{\stretch{0.618}}

		\end{center}

	\Large{17. 11. 2017} \hfill Jiøí Matìjka
	\thispagestyle{empty}
	\newpage
	\setcounter{page}{1}

    \tableofcontents
	\newpage
	\newpage

    \section{Úvod}
        Program popser je POP3 server umo¾òující pøipojení více klientù najednou.
		Klienti mohou komunikovat se serverem pomocí protokolu POP3. Server pracuje
		s~emaily ve fromátu IMF v~adresáøové struktuøe typu Maildir. Server
		pracuje pouze s~jednou po¹tovní schránkou, do které mù¾e vstoupit pouze
		jeden u¾ivatel.

    \section{Uvedení do problematiky}
        V~této èásti dokumentu je struènì popsán formát IMF a~Maildir. Dále
		je zde popsána komunikace a~funkènost POP3 serveru.

		\subsection{IMF - Internet message format}
			Internetová zpráva ve formatu IMF není nic jiného, ne¾ série znakù. Znaky
			mohou nabývat \texttt{US-ASCII} hodnot 1-127 \cite{web:imf}.

			Zprávu tvoøí jednotlivé øádky. Ka¾dý øádek je ukonèena dvìmi po sobì jdoucími znaky -
			\texttt{CR} (\texttt{ASCII} hodnota 13) a~\texttt{LF} (\texttt{ASCII} hodnota 10) \cite{web:imf}.

			Zpráva se dále skládá z~hlavièky, po které mù¾e následovat tìlo.
			Hlavièka je sekvence øádkù. Na ka¾dém øádku hlavièky je název pole
			a jeho hodnota oddìlená ":". Hlavièka je ukonèena prázdným øádkem.
			Tìlo je opìt sekvence øádkù \cite{web:imf}.

		\subsection{Maildir}
			Adresáøová struktura Maildir je vhodná pro tøídìní emailù. Ka¾dý
			u¾ivatel má vlastní slo¾ku Maildir a~v~ní jsou slo¾ky cur, new a
			tmp. Se slo¾kou tmp pracuje pouze SMTP server.

		\subsection{Odeslání zprávy klientovi}
			Pokud klient pou¾ije jeden z~pøíkazù k~získání emailu, POP3 server
			danný email ode¹le. Aby klient vedìl, kdy server odeslal celou
			zprávu, ode¹le na konci emailu osamocenou teèku na øádku a~dále
			nic neposílá. Pokud øádek zprávy zaèíná teèkou, server pøidá dal¹í
			teèku na zaèátek øádku.

		\newpage
		\subsection{POP3 pøíkazy}
			Ní¾e jsou uvedeny v¹echny mo¾né dotazy, vèetnì volitelných, na POP3
			server. Vèechny tyto pøíkazy jsou implementovány v~programu popser.
			\begin{itemize}
				\item \texttt{USER} jmeno\_uzivatele
				\item \texttt{PASS} heslo
				\item \texttt{APOP} jmeno\_uzivatele heslo
				\item \texttt{STAT}
				\item \texttt{LIST} [message\_id]
				\item \texttt{RETR} message\_id
				\item \texttt{DELE} message\_id
				\item \texttt{NOOP}
				\item \texttt{RSET}
				\item \texttt{QUIT}
				\item \texttt{TOP} message\_id lines
				\item \texttt{UIDL} [message\_id]
			\end{itemize}
			Pro pøihlá¹ení na server slou¾í pøíkazy \texttt{USER}, \texttt{PASS} a~\texttt{APOP}. \texttt{APOP} vyu¾ívá
			md5 k~zakódování hesla. Klíè obdr¾í od serveru na zaèátku spojení a~ke
			klíèi pøipojí své heslo a~výsledný øetìzec znakù za¹ifruje md5 algoritmem.
			\texttt{USER} a~\texttt{PASS} slou¾í k~ne¹ifrovanému pøenosu. Pokud server podporuje \texttt{APOP},
			nesmí podporovat pøíkazy \texttt{USER} ani \texttt{PASS} a~obrácenì. V~programu popser lze
			pøepínat mezi podporou tìchto pøíkazù pomocí argumentù programu pøi jeho
			spu¹tìní \cite{web:pop3}.

			K~pøeètení zprávy lze pou¾ít pøíkazy \texttt{TOP} a~\texttt{RETR}. Pomocí pøíkazy \texttt{TOP}
			klient získá hlavièku zprávy a~pøedem zadaný poèet øádkù zprávy (parametr lines),
			pokud je zadané vìt¹í èíslo, ne¾ je celkový poèet øádkù, ode¹le se celý email \cite{web:pop3}.

			K~získání identifikátorù emailù lze pou¾ít pøíkazi \texttt{LIST} a~\texttt{UIDL}. List
			vypí¹e v¹echny emaily, které nejsou oznaèeny ke smazaní a~ka¾dému pøidìlí
			\texttt{ID} a~vedle \texttt{ID} vypí¹e jeho velikost v~oktetech. \texttt{UIDL} k~\texttt{ID} zprávám vypí¹e
			jejich unikátní \texttt{ID} v~rámci celého Maildiru. \texttt{ID} zpráv se na rozdíl od
			tohoto unikátního \texttt{ID} mù¾e mìnit (\texttt{ID} je unikátní pouze v rámci jednoho
			sezení) \cite{web:pop3}.

			Pro zji¹tìní velikosti Maildiru (bez slo¾ky tmp) lze pou¾ít pøíkaz \texttt{STAT}.
			Uvedená velikost je v~oktetech \cite{web:pop3}.

			\texttt{DELE} slou¾í k~mazání zpráv. Zprávy se ma¾ou a¾ po zadání pøíkazu \texttt{QUIT}.
			Do té doby je mo¾né obnovit zprávy oznaèené ke smazání pøíkazem \texttt{RSET} \cite{web:pop3}.

			Na pøíkaz \texttt{NOOP} server pouze odpoví \cite{web:pop3}.
		\newpage
		\subsection{stavy serveru}
			POP3 server má 3 základní stavy.
			\begin{itemize}
				\item AUTHORIZATION
				\item TRANSACTION
				\item UPDATE
			\end{itemize}

			Ve stavu AUTHORIZATION lze pouze pou¾ívát pøíkazy \texttt{USER}, \texttt{PASS}, \texttt{APOP} a~\texttt{QUIT},
			tento stav slou¾í k~autorizaci u¾ivatle, poté co se u¾ivatel proká¾e
			platnými pøihla¹ovacími údaji, pøejde se do stavu TRANSACTION. Ve stavu
			TRANSACTION lze pou¾ít v¹echny pøíkazy, vyjma \texttt{USER}, \texttt{PASS} a~\texttt{APOP}. Stav
			TRANSACTION trvá doku klient nezadá \texttt{QUIT}, poté se pøejde do stavu UPDATE.
			Ve stavu UPDATE se provede mazání zpráv a~následné ukonèení komunikace \cite{web:pop3}.

    \section{Návrh programu}
		Po pøipojení klienta na server, aplikace popser ode¹le uvítací zprávu s~klíèem
		pro ¹ifrování. Klíè se nacházi na konci zprávy a~je ve formátu <process-ID.clock.socket\_descriptor@hostname>.
		Následnì program oèekává pøíkaz \texttt{APOP} nebo \texttt{USER} a~\texttt{PASS}, podle argumentù programu.
		Po úspì¹ném pøihlá¹ení u¾ivatele server pøistoupí k~Maildir a~pøesune v¹echny
		zprávy ze slo¾ky new do cur. Následnì server oèekává dal¹í pøíkazy od klienta.
		Pokud klient zadá pøíkaz \texttt{QUIT}, server sma¾e v¹echny soubory oznaèené ke smazání.
		Pokud se klient odpojí bez u¾ití pøíkazu \texttt{QUIT} nebo se spojení pøeru¹í,
		emaily oznaèené ke smazání zùstanou nedotèeny.

	\section{Implementace}
		Program je implementován v~jazyce C a~C++. Program vyu¾ívá objektového programování,
		má deklarované tøídy Mail\_file, Mail\_dir a~Arguments a~vyu¾ívá nìkteré objekty i
		ze standartních knihoven C++, napøíklad vector nebo string. Pro md5 algoritmus byla
		pou¾ita tøída md5 \cite{web:md5}.

		Aplikace je vytvoøena pro operaèní systém Linux a~byla vyvýjena
		na Ubuntu 16.04 LTS a~testována na systémech Ubuntu 16.04 LTS a~CentOS 7.4

		Program je pøekládán pomocí pøekladaèe g++ a~pro pøeklad slou¾í soubor
		Makefile.

	\section{Návod k pou¾ití}
		V této èásti dokuemtu je uveden návod k pou¾ítí a pár pøíkladu u¾ití.
		\subsection{Pøeklad aplikace}
			Aplikaci lze pøelo¾it pøíkazem make ve slo¾ce se souborem Makefile.
		\subsection{Spu¹tìní serveru}
			Server má 3 re¾imy bìhu.
			\begin{itemize}
				\item{ popser -r }
				\item{ popser -h }
				\item{ popser -a AUTH\_FILE -d MAILDIR -p PORT [ -c ] [ -r ] }
			\end{itemize}
			Argument -h vypí¹e struèný návod k obsluze programu. Argument -r uvede
			slo¾ku Maildir do pùvodního stavu (kromì obnovení smazaných emailù).
			\texttt{AUTH\_FILE} je cesta k souboru s u¾ivatelským jménem a heslem. \texttt{MAILDIR}
			je cesta ke slo¾ce, která obsahuje minimálnì slo¾ky new a cur. S touto
			slo¾kou bude následnì popser pracovat. \texttt{PORT} je èíslo portu, na kterém
			se budou moci pøipojit klienti. Pokud je zadám parametr -c, tak se
			se pøihla¹ovací údaje zadávají pomocí \texttt{USER} a \texttt{PASS} a heslo je na síti
			pøená¹eno ne¹ifrovanì. Pokud -c zadán není, autorizace probíhá pomocí
			pøíkazu \texttt{APOP}.
		\subsection{Pøíklady}
			\begin{itemize}
				\item {popser -a ./user.txt -p 8888 -d ./Maildir/}
			\end{itemize}
			Ze souboru ./user.txt budou naèteny u¾ivatelské údaje. Ve slo¾ce ./Maildir/
			budou oèekávany slo¾ky cur a new ve kterých se budou nacházet soubory
			reprezentující emaily. Na portu 8888 bude probíhat komunikace a k
			autorizovat se bude muset u¾ivatel pomocí pøíkazu \texttt{APOP}.

			\begin{itemize}
					\item {popser -r}
			\end{itemize}
			Soubor uvede Maildir zvrátí ve¹keré operace se soubory (kromì odstranìní).

	\section{Závìr}
       Aplikaci popser lze pou¾ít jako POP3 server pro správu jediného úètu. Jsou
	   v~nìm implementovány v¹echny povinné i volitelné funkcionality a~byl vyvynut
	   pro operaèní systém Linux.

	\newpage
	\bibliography{literatura}
\end{document}